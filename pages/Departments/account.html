<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>حسابي - Dark Shop</title>
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/account.css">
</head>
<body>

<div class="account-container">
    <div class="account-header">حسابي</div>

    <div class="account-section">
        <h3>البيانات الشخصية</h3>
        <label for="username">الاسم:</label>
        <input type="text" id="username">
        <label for="email">الإيميل:</label>
        <input type="email" id="email" disabled>
        <label for="password">كلمة المرور:</label>
        <input type="password" id="password">
        <button id="saveData">حفظ البيانات</button>
        <button id="logoutBtn" style="background:red; margin-top:10px;">تسجيل خروج</button>
    </div>

    <div class="account-section">
        <h3>الطلبات السابقة</h3>
        <div class="orders-list" id="ordersList">لا توجد طلبات بعد.</div>
    </div>

    <div id="addProductContainer" style="display:none;">
        <button id="addProductBtn">إضافة منتج جديد</button>
    </div>
</div>

<script src="/assets/js/components.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
const supabaseClient = supabase.createClient(
  'https://uwlomazzncrejbgxifuc.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3bG9tYXp6bmNyZWpiZ3hpZnVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMDMwODYsImV4cCI6MjA3Njg3OTA4Nn0.2imMbjsn-7mHd28HvPTJk9BGEu04JqfcESDNoBV-pSM'
);

document.addEventListener("DOMContentLoaded", async () => {
    const usernameInput = document.getElementById("username");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const saveBtn = document.getElementById("saveData");
    const logoutBtn = document.getElementById("logoutBtn");
    const ordersList = document.getElementById("ordersList");
    const addProductContainer = document.getElementById("addProductContainer");
    const addProductBtn = document.getElementById("addProductBtn");

    // جلب الجلسة
    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
    if(sessionError || !session){
        window.location.href = "login.html";
        return;
    }
    const userId = session.user.id;

    // جلب بيانات البروفايل
    const { data: profile, error } = await supabaseClient
        .from("profiles")
        .select("username, role")
        .eq("id", userId)
        .single();
    if(error){
        console.error("خطأ في جلب بيانات البروفايل:", error.message);
        return;
    }

    usernameInput.value = profile.username || "";
    emailInput.value = session.user.email || "";

    // إظهار زر إضافة منتج فقط إذا الدور admin
    if(profile.role === "admin"){
        addProductContainer.style.display = "block";
        addProductBtn.addEventListener("click", ()=>{
            window.location.href = "addProduct.html";
        });
    } else {
        addProductContainer.style.display = "none";
    }

    // عرض الطلبات السابقة من LocalStorage
    function displayOrders(){
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        if(cart.length === 0){
            ordersList.innerHTML = "لا توجد طلبات بعد.";
            return;
        }
        ordersList.innerHTML = "";
        cart.forEach((item, index)=>{
            const div = document.createElement("div");
            div.innerHTML = `<span>${item.name} - ${item.quantity} × ${item.price} جنيه</span>
                             <button data-index="${index}" class="deleteOrder">حذف</button>`;
            ordersList.appendChild(div);
        });

        document.querySelectorAll(".deleteOrder").forEach(btn=>{
            btn.addEventListener("click", e=>{
                const i = e.target.dataset.index;
                cart.splice(i,1);
                localStorage.setItem("cart", JSON.stringify(cart));
                displayOrders();
            });
        });
    }

    displayOrders();

    // حفظ البيانات
    saveBtn.addEventListener("click", async ()=>{
        const newName = usernameInput.value.trim();
        const newPassword = passwordInput.value.trim();
        if(!newName){
            alert("❌ يرجى كتابة الاسم!");
            return;
        }

        const { error: profileError } = await supabaseClient
            .from("profiles")
            .update({ username: newName })
            .eq("id", userId);
        if(profileError){
            alert("❌ فشل في تحديث الاسم: "+profileError.message);
            return;
        }

        if(newPassword){
            const { error: passError } = await supabaseClient.auth.updateUser({ password: newPassword });
            if(passError){
                alert("❌ فشل في تحديث كلمة المرور: "+passError.message);
                return;
            }
        }

        alert("✅ تم حفظ البيانات بنجاح!");
        passwordInput.value = "";
    });

    // تسجيل الخروج
    logoutBtn.addEventListener("click", async ()=>{
        await supabaseClient.auth.signOut();
        window.location.href = "login.html";
    });

    // مراقبة حالة الجلسة
    supabaseClient.auth.onAuthStateChange((event, session)=>{
        if(!session){
            window.location.href = "login.html";
        }
    });
});
</script>

</body>
</html>
